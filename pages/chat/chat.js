require("../../common/manifest.js");
require("../../common/vendor.js");
global.webpackJsonp([0],{103:function(t,e,s){"use strict";var n=i(s(2)),o=i(s(104));function i(t){return t&&t.__esModule?t:{default:t}}Page((0,n.default)(o.default))},104:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=s(106),o=s.n(n),i=s(115),a=!1;var r=function(t){a||s(105)},c=s(0)(o.a,i.a,r,null,null);c.options.__file="..\\..\\..\\..\\data\\work\\ShareChat\\uniapp\\pages\\chat\\chat.vue",c.esModule&&Object.keys(c.esModule).some(function(t){return"default"!==t&&"__"!==t.substr(0,2)})&&console.error("named exports are not supported in *.vue files."),c.options.functional&&console.error("[vue-loader] chat.vue: functional components are not supported with templates, they should use render functions."),e.default=c.exports},105:function(t,e){},106:function(t,e,s){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0});var n=s(3),o=(a(s(6)),a(s(107))),i=a(s(111));function a(t){return t&&t.__esModule?t:{default:t}}e.default={data:function(){return{style:{pageHeight:0,contentViewHeight:0,footViewHeight:90,mitemHeight:0},messages:[],msg:"",scrollTop:0,socketOpen:!1,lastId:"",isFirstSend:!0,ccid:null,group:{},members:{},group_id:null,title:"title",serial:0}},onLoad:function(e){this.group_id=e.group_id,this.title=e.title;var s=t.getSystemInfoSync();this.style.pageHeight=s.windowHeight,this.style.contentViewHeight=s.windowHeight-t.getSystemInfoSync().screenWidth/750*100,this.getGroupInfo(),this.fetchChatContents()},onReady:function(){},onShow:function(){this.ensure_connect()},onUnload:function(){t.closeSocket()},onHide:function(){t.closeSocket()},computed:(0,n.mapState)(["forcedLogin","hasLogin","userInfo"]),components:{chatInput:o.default,messageShow:i.default},methods:{getGroupInfo:function(){var t=this,e=this.app.getCache(this.group_id);if(!e){var s={group_id:this.group_id};this.app.httpGet("/api/chat/groupinfo",s,function(e){var s=e.data.data.group;return t.group=s,t.app.setCache(t.group_id,s),t.updateMembers(s),t.setTitle(),s})}return t.updateMembers(e),t.setTitle(),e},fetchChatContents:function(){var t=this,e=this.app,s={group_id:this.group_id,ccid:this.ccid,forward:!0,num:20};e.httpGet("/api/chat/contents",s,function(e){for(var s=e.data.data.messages,n=0;n<s.length;n++)t.fmtChatMessage(s[n]);t.messages=s.concat(t.messages),s.length>0&&(t.ccid=s[0].id),t.scrollToBottom()})},updateMembers:function(t){for(var e=t.members,s=0;s<e.length;s++){var n=e[s];this.members[n.id]=n}this.members=this.members,console.log("updateMembers----",this.members)},getInputMessage:function(t){this.msg=t.content,this.send()},scrollToBottom:function(){var e=this,s=t.createSelectorQuery();s.selectAll(".m-item").boundingClientRect(),s.select("#scrollview").boundingClientRect(),s.exec(function(t){e.style.mitemHeight=0,t[0].forEach(function(t){e.style.mitemHeight=e.style.mitemHeight+t.height+20}),e.style.mitemHeight>e.style.contentViewHeight&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight)})},ensure_connect:function(){if(!this.socketOpen){var e=this.group_id,s=this.app.getJwtToken(),n="?group_id={0}&token={1}".format(e,s);t.connectSocket({url:this.app.envConfig.WS_HOST+n}),t.onSocketOpen(this.onOpen),t.onSocketMessage(this.onMessage),t.onSocketError(this.onError),t.onSocketClose(this.onClose)}},onOpen:function(e){t.showToast({title:"onOpen"}),this.serial=1,this.socketOpen=!0},onMessage:function(t){console.log("onSocketMessage",t),console.log("onSocketMessage-userinfo",this.userInfo);var e=this.fmtChatMessage(JSON.parse(t.data)),s=this.isFirstSend,n=this.messages,o="";s?(o=(n=n.concat(e))[0].id,this.messages=n,this.lastId=o,this.isFirstSend=!1,this.delayPageScroll()):(n.push(e),o=n[n.length-1].id,this.messages=n,this.lastId=o);this.scrollToBottom()},onClose:function(e){this.socketOpen=!1,this.serial=0,t.showToast({title:"WebSocket 已关闭！"}),console.log("WebSocket 已关闭！")},onError:function(e){console.log(e),console.log("WebSocket连接打开失败，请检查！"),t.showToast({title:"WebSocket连接打开失败，请检查！"})},send:function(){this.ensure_connect();this.messages.length;var e=this.msg;if(console.log("send",this.msg),""===e)return t.showToast({title:"请输入内容",icon:"loading",duration:1e3}),!1;var s={content:e,subtype:2};this.msg="",t.sendSocketMessage({data:JSON.stringify(s)})},fmtChatMessage:function(t){var e=this.members[t.creator_id];return e&&(t.creator=e),t.creator_id==this.userInfo.id?t.is_creator=!0:t.is_creator=!1,console.log("fmtChatMessage",t),t},setTitle:function(){var e=this.title||this.group.name;t.setNavigationBarTitle({title:e})},delayPageScroll:function(){var t=this,e=this.messages,s=e[e.length-1].id;setTimeout(function(){t.lastId=s,t.scrollToBottom()},300)}}}}).call(e,s(1).default)},107:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=s(109),o=s.n(n),i=s(110),a=!1;var r=function(t){a||s(108)},c=s(0)(o.a,i.a,r,null,null);c.options.__file="..\\..\\..\\..\\data\\work\\ShareChat\\uniapp\\components\\im-chat\\chatinput.vue",c.esModule&&Object.keys(c.esModule).some(function(t){return"default"!==t&&"__"!==t.substr(0,2)})&&console.error("named exports are not supported in *.vue files."),c.options.functional&&console.error("[vue-loader] chatinput.vue: functional components are not supported with templates, they should use render functions."),e.default=c.exports},108:function(t,e){},109:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"chat-input",data:function(){return{inputValue:""}},methods:{startRecognize:function(){var t={},e=this;t.engine="iFly",e.inputValue="",plus.speech.startRecognize(t,function(t){console.log(t),e.inputValue+=t},function(t){console.log("语音识别失败："+t.message)})},sendMessge:function(){""==this.inputValue.trim()?this.inputValue="":(this.$emit("send-message",{type:"text",content:this.inputValue}),this.inputValue="")}}}},110:function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("view",{staticClass:"footer"},[s("view",{staticClass:"footer-left"},[s("view",{staticClass:"uni-icon uni-icon-mic",attrs:{eventid:"6RX-0"},on:{tap:t.startRecognize}})]),s("view",{staticClass:"footer-center"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.inputValue,expression:"inputValue"}],staticClass:"input-text",attrs:{type:"text",eventid:"ifY-1"},domProps:{value:t.inputValue},on:{input:function(e){e.target.composing||(t.inputValue=e.target.value)}}})]),s("view",{staticClass:"footer-right",attrs:{eventid:"dUB-2"},on:{tap:t.sendMessge}},[s("view",{attrs:{id:"msg-type"}},[t._v("发送")])])])};n._withStripped=!0;var o={render:n,staticRenderFns:[]};e.a=o},111:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=s(113),o=s.n(n),i=s(114),a=!1;var r=function(t){a||s(112)},c=s(0)(o.a,i.a,r,null,null);c.options.__file="..\\..\\..\\..\\data\\work\\ShareChat\\uniapp\\components\\im-chat\\messageshow.vue",c.esModule&&Object.keys(c.esModule).some(function(t){return"default"!==t&&"__"!==t.substr(0,2)})&&console.error("named exports are not supported in *.vue files."),c.options.functional&&console.error("[vue-loader] messageshow.vue: functional components are not supported with templates, they should use render functions."),e.default=c.exports},112:function(t,e){},113:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={props:["message","id","userInfo"]}},114:function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.message.is_creator?t.message.is_creator?s("view",{staticClass:"m-item",attrs:{id:t.message.id}},[s("view",{staticClass:"m-left"}),s("view",{staticClass:"m-content"},[s("view",{staticClass:"m-content-head",class:{"m-content-head-right":!0}},[s("view",{staticClass:"m-content-head-customer"},[t._v(t._s(t.message.content)+" ")])])]),s("view",{staticClass:"m-right"},[s("image",{staticClass:"head_icon",attrs:{src:t.message.creator.avatar}})])]):t._e():s("view",{staticClass:"m-item",attrs:{id:t.message.id}},[s("view",{staticClass:"m-left"},[s("image",{staticClass:"head_icon",attrs:{src:t.message.creator.avatar}})]),s("view",{staticClass:"m-content"},[s("view",{staticClass:"m-content-head",class:{"m-content-head-right":!1}},[s("view",{staticClass:"m-content-head-home"},[t._v(t._s(t.message.content)+" ")])])]),s("view",{staticClass:"m-right"})])};n._withStripped=!0;var o={render:n,staticRenderFns:[]};e.a=o},115:function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("view",{staticClass:"page",staticStyle:{width:"100%"}},[s("view",{staticClass:"uni-column"},[s("view",{staticClass:"content",style:{height:t.style.contentViewHeight+"upx"},attrs:{id:"content"}},[s("scroll-view",{style:{height:t.style.contentViewHeight+"upx"},attrs:{id:"scrollview","scroll-y":"true","scroll-with-animation":!0,"scroll-top":t.scrollTop}},[t._l(t.messages,function(e,n){return s("message-show",{key:n,attrs:{message:e,id:n,userInfo:t.userInfo,mpcomid:"iB9-0-"+n}})}),s("view",{attrs:{id:"bottom"}})],2)],1),s("view",{staticClass:"foot"},[s("chat-input",{attrs:{eventid:"wof-0",mpcomid:"psV-1"},on:{"send-message":t.getInputMessage,focus:t.inputGetFocus}})],1)])])};n._withStripped=!0;var o={render:n,staticRenderFns:[]};e.a=o}},[103]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/chat/chat.js.map